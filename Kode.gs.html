// --- KONFIGURASI ---
var DOC_ASLI_ID = "1eURvpy7nplm6wUlvgEhZJDCI0SaI1EqiURnARaTaDsY"; // Masukkan ID Doc Anda
var ANCHOR_POINT = "DENGAN"; // Header cutoff

function doGet() {
  return HtmlService.createHtmlOutputFromFile('index')
      .setTitle('Analisis Dokumen (Smart Offset Fix)');
}

function prosesUpload(formObject) {
  var rawFileId = null;
  var convertedFileId = null;

  try {
    var blob = formObject.filePdf;
    if (!blob || blob.getName() == "") return "Error: File belum dipilih.";

    // 1. Upload & OCR
    var rawFile = DriveApp.createFile(blob);
    rawFileId = rawFile.getId();
    var mimeType = rawFile.getMimeType();
    var textPdfRaw = "";

    if (mimeType === MimeType.PDF || mimeType === "application/pdf") {
      var resource = { title: "[TEMP] " + blob.getName(), mimeType: MimeType.GOOGLE_DOCS };
      var convertedFile = Drive.Files.copy(resource, rawFileId, {ocr: true});
      convertedFileId = convertedFile.id;
      textPdfRaw = DocumentApp.openById(convertedFileId).getBody().getText();
    } else {
      textPdfRaw = DocumentApp.openById(rawFileId).getBody().getText();
    }

    // 2. Baca Doc
    var docAsli = DocumentApp.openById(DOC_ASLI_ID);
    var textDocRaw = docAsli.getBody().getText();

    // 3. Bersihkan
    if (rawFileId) try { DriveApp.getFileById(rawFileId).setTrashed(true); } catch(x){}
    if (convertedFileId) try { DriveApp.getFileById(convertedFileId).setTrashed(true); } catch(x){}

    // 4. Analisis
    return bandingkanFollowPdf(textDocRaw, textPdfRaw);

  } catch (e) {
    if (rawFileId) try { DriveApp.getFileById(rawFileId).setTrashed(true); } catch(x){}
    if (convertedFileId) try { DriveApp.getFileById(convertedFileId).setTrashed(true); } catch(x){}
    return "Error System: " + e.toString();
  }
}

// --- LOGIKA UTAMA ---

function bandingkanFollowPdf(textDoc, textPdf) {
  var linesPdf = cleanAndSlice(textPdf); 
  var docLinesRaw = cleanAndSlice(textDoc);
  var streamDoc = docLinesRaw.join(" ").replace(/\s+/g, " ").trim(); 
  
  if (linesPdf.length === 0) {
    return "<h3>‚ö†Ô∏è Anchor '" + ANCHOR_POINT + "' tidak ditemukan di PDF.</h3>";
  }

  var html = "<h3>‚úÖ Hasil Analisis (Support Huruf a., b., dst):</h3><ul>";
  var diffCount = 0;

  for (var i = 0; i < linesPdf.length; i++) {
    var lineP = linesPdf[i].replace(/\s+/g, " ").trim(); 
    if (lineP === "") continue;

    var matchResult = smartSearchInStream(streamDoc, lineP);

    if (matchResult.found) {
      // 1. Teks Terlewati
      var skippedText = streamDoc.substring(0, matchResult.startIndex).trim();
      if (skippedText.length > 0) {
        html += itemHtml("‚ùå Ada di Doc, Hilang di PDF", skippedText, "", "merah");
        diffCount++;
      }

      // 2. Cek Kecocokan & Generate Diff
      var matchedDocText = matchResult.text;
      
      // Gunakan Smart Diff Generator yang baru (Auto Offset)
      var finalDiff = generateSmartDiff(matchedDocText, lineP);
      
      // Hitung jumlah error (span merah)
      var errorCount = (finalDiff.doc.match(/background-color:#ffcccc/g) || []).length;

      if (errorCount === 0) {
         html += itemHtml("‚úÖ Cocok", matchedDocText, lineP, "normal"); 
      } else {
         html += itemHtml("‚ö†Ô∏è Beda Isi / Typo", finalDiff.doc, finalDiff.pdf, "kuning", true);
         diffCount++;
      }

      streamDoc = streamDoc.substring(matchResult.endIndex);

    } else {
      html += itemHtml("‚ûï Tambahan di PDF", "", lineP, "hijau");
      diffCount++;
    }
  }

  if (streamDoc.trim().length > 0) {
    html += itemHtml("‚ùå Sisa Teks di Doc", streamDoc, "", "merah");
    diffCount++;
  }

  html += "</ul>";
  if (diffCount === 0) html = "<h3>üéâ Dokumen IDENTIK!</h3>" + html;
  
  return html;
}

// --- SMART DIFF GENERATOR (REVISI: ANTI-DESYNC) ---
// Fungsi ini menggunakan logika "Lookahead" untuk menangani pergeseran kata
// akibat placeholder (<<..>>) atau penomoran tambahan (6., a., dll).
function generateSmartDiff(textDoc, textPdf) {
  var wordsDoc = textDoc.split(" ");
  var wordsPdf = textPdf.split(" ");
  
  var htmlDoc = "";
  var htmlPdf = "";
  
  var pIdx = 0; // Pointer PDF
  var dIdx = 0; // Pointer Doc
  
  // Batas seberapa jauh kita mencari kecocokan jika terjadi beda (Window Size)
  var SEARCH_WINDOW = 5; 

  while (pIdx < wordsPdf.length || dIdx < wordsDoc.length) {
    var wP = wordsPdf[pIdx] || "";
    var wD = wordsDoc[dIdx] || "";
    
    // Normalisasi untuk cek kecocokan (abaikan huruf besar/kecil & simbol)
    var cleanP = normalizeSimple(wP);
    var cleanD = normalizeSimple(wD);
    
    // 1. JIKA COCOK LANGSUNG
    if (cleanP === cleanD) {
      if (wD) htmlDoc += formatNormal(wD) + " ";
      if (wP) htmlPdf += formatNormal(wP) + " ";
      pIdx++;
      dIdx++;
    } 
    // 2. JIKA TIDAK COCOK, CARI TITIK TEMU (SYNC)
    else {
      var syncFound = false;

      // Cek: Apakah PDF menyisipkan kata tambahan? (Contoh: "6. Peraturan")
      // Kita cari apakah kata Doc saat ini (wD) ada di PDF beberapa langkah ke depan?
      for (var i = 1; i <= SEARCH_WINDOW; i++) {
        if ((pIdx + i) < wordsPdf.length) {
          var nextP = normalizeSimple(wordsPdf[pIdx + i]);
          if (nextP === cleanD && cleanD !== "") {
            // Ketemu! Berarti kata-kata di PDF dari pIdx s.d sebelum ketemu adalah TAMBAHAN
            for (var k = 0; k < i; k++) {
              htmlPdf += formatError(wordsPdf[pIdx + k]) + " ";
            }
            // Majukan pointer PDF saja, Doc diam
            pIdx += i;
            syncFound = true;
            break;
          }
        }
      }

      if (!syncFound) {
        // Cek Kebalikannya: Apakah Doc punya kata ekstra/placeholder yg hilang di PDF?
        // (Contoh: "<<Hari PKS>>" vs "Jumat" -> "tanggal" ketemu nanti)
        for (var j = 1; j <= SEARCH_WINDOW; j++) {
          if ((dIdx + j) < wordsDoc.length) {
            var nextD = normalizeSimple(wordsDoc[dIdx + j]);
            if (nextD === cleanP && cleanP !== "") {
              // Ketemu! Kata di Doc adalah HAPUSAN/PLACEHOLDER
              for (var k = 0; k < j; k++) {
                htmlDoc += formatError(wordsDoc[dIdx + k]) + " ";
              }
              // Majukan pointer Doc saja, PDF diam
              dIdx += j;
              syncFound = true;
              break;
            }
          }
        }
      }
      
      // 3. JIKA TETAP TIDAK KETEMU TITIK TEMU (BEDA ISI MURNI)
      if (!syncFound) {
        // Tandai kata ini saja sebagai beda, lalu lanjut ke kata berikutnya
        if (wD) htmlDoc += formatError(wD) + " ";
        if (wP) htmlPdf += formatError(wP) + " ";
        pIdx++;
        dIdx++;
      }
    }
  }
  
  return { doc: htmlDoc.trim(), pdf: htmlPdf.trim() };
}

// --- Helper Formatting ---

function normalizeSimple(str) {
  if (!str) return "";
  return str.replace(/[^a-zA-Z0-9]/g, "").toLowerCase();
}

function formatNormal(text) {
  return escapeHtml(text);
}

function formatError(text) {
  // Style merah untuk perbedaan
  return "<span style='background-color:#ffcccc; color:#d93025; font-weight:bold; padding:0 2px; border-radius:2px;'>" + escapeHtml(text) + "</span>";
}

// --- HELPER SMART SEARCH ---
function smartSearchInStream(stream, pdfLine) {
  var res = { found: false, startIndex: -1, endIndex: -1, text: "" };
  
  // 1. Coba Cari Persis
  var try1 = performSearch(stream, pdfLine);
  if (try1.found) return try1;

  // 2. Coba Cari Tanpa Nomor (Regex diperkuat)
  var cleanLine = removeNumbering(pdfLine);
  if (cleanLine !== pdfLine && cleanLine.length > 3) {
    var try2 = performSearch(stream, cleanLine);
    if (try2.found) return try2;
  }
  return res;
}

// --- UPDATE FIX: DYNAMIC SEARCH HORIZON ---
function performSearch(stream, textToFind) {
  var res = { found: false, startIndex: -1, endIndex: -1, text: "" };
  var words = textToFind.split(" ");
  var searchHead = "";
  var searchTail = "";
  var isLong = words.length >= 6;

  if (!isLong) {
    searchHead = textToFind;
  } else {
    searchHead = words.slice(0, 3).join(" ");
    searchTail = words.slice(-3).join(" ");
  }

  var idxHead = stream.toLowerCase().indexOf(searchHead.toLowerCase());
  
  if (idxHead !== -1) {
    var endIndexFound = -1;
    
    if (!isLong) {
      endIndexFound = idxHead + searchHead.length;
    } else {
      // --- PERBAIKAN DI SINI ---
      // Jangan pakai fixed 4000. Gunakan range dinamis.
      // Kita hanya mencari sejauh 3x panjang teks asli (atau minimal 200 karakter).
      // Ini mencegah teks pendek di PDF "mencaplok" teks sampai akhir dokumen Doc.
      var searchHorizon = Math.max(200, textToFind.length * 3); 
      
      var subStream = stream.substring(idxHead, idxHead + searchHorizon);
      var tailLower = searchTail.toLowerCase();
      
      var bestMatchLen = -1;
      var minDiff = Number.MAX_VALUE;
      var currentPos = 0;
      var targetLength = textToFind.length;

      // Loop cari kandidat ekor terbaik dalam range aman
      while (true) {
        var foundTail = subStream.toLowerCase().indexOf(tailLower, currentPos);
        if (foundTail === -1) break; 

        var candidateLen = foundTail + searchTail.length;
        var diff = Math.abs(candidateLen - targetLength);

        if (diff < minDiff) {
          minDiff = diff;
          bestMatchLen = candidateLen;
        }

        currentPos = foundTail + 1;
      }

      if (bestMatchLen !== -1) {
        // SAFETY CHECK TERAKHIR:
        // Jika hasil temuan ternyata > 4x lebih panjang dari aslinya, 
        // abaikan (kemungkinan salah tangkap ekor yang umum).
        if (bestMatchLen > (targetLength * 4)) {
           endIndexFound = idxHead + targetLength; // Potong manual
        } else {
           endIndexFound = idxHead + bestMatchLen;
        }
      } else {
        // Fallback: Ekor tidak ketemu dalam range
        endIndexFound = idxHead + textToFind.length;
      }
      
      // Pastikan tidak melebihi batas stream
      if (endIndexFound > stream.length) endIndexFound = stream.length;
    }
    
    return { 
      found: true, 
      startIndex: idxHead, 
      endIndex: endIndexFound, 
      text: stream.substring(idxHead, endIndexFound) 
    };
  }
  
  return res;
}

function removeNumbering(str) {
  // Regex: 
  // ^               = Awal baris
  // [\s\(]* = Spasi atau kurung buka (opsional)
  // [0-9a-zA-Z]{1,3}= Angka/Huruf 1-3 digit (1, 10, a, aa, IV)
  // \s* = Spasi (mungkin ada antara huruf dan titik)
  // [\.\)]          = Titik atau Kurung Tutup
  // \s* = Spasi setelahnya
  return str.replace(/^[\s\(]*[0-9a-zA-Z]{1,3}\s*[\.\)]\s*/, "");
}

function itemHtml(label, textDoc, textPdf, warna, isHtml) {
  var styleDoc = "color:#333;";
  var stylePdf = "color:#333;";
  var rowStyle = "border-left: 4px solid #ccc;";

  if (warna === "merah") { 
    styleDoc = "background:#ffe6e6; color:#d93025; text-decoration:line-through;";
    stylePdf = "display:none;";
    rowStyle = "border-left: 4px solid #d93025;";
  } else if (warna === "hijau") { 
    styleDoc = "display:none;";
    stylePdf = "background:#e6ffe6; color:#188038;";
    rowStyle = "border-left: 4px solid #188038;";
  } else if (warna === "kuning") { 
    styleDoc = "background:#fff8e1; color:#333;"; 
    stylePdf = "background:#fff8e1; color:#333;";
    rowStyle = "border-left: 4px solid #f9ab00;";
  } else { 
    styleDoc = "color:#5f6368;"; 
    stylePdf = "color:#5f6368;";
    rowStyle = "border-left: 4px solid #1e8e3e;"; 
  }

  var contentDoc = isHtml ? textDoc : escapeHtml(textDoc);
  var contentPdf = isHtml ? textPdf : escapeHtml(textPdf);

  var html = "<li style='margin-bottom:10px; background:#fff; padding:8px; list-style:none; box-shadow:0 1px 2px rgba(0,0,0,0.1); " + rowStyle + "'>" +
             "<div style='font-weight:bold; font-size:12px; margin-bottom:4px; color:#444;'>" + label + "</div>";
             
  if (textDoc) html += "<div style='font-size:13px; font-family:monospace; white-space:pre-wrap; " + styleDoc + "'>üìÑ Doc: " + contentDoc + "</div>";
  if (textPdf) html += "<div style='font-size:13px; font-family:monospace; white-space:pre-wrap; border-top:1px dashed #ddd; margin-top:4px; padding-top:4px; " + stylePdf + "'>üìë PDF: " + contentPdf + "</div>";
  
  html += "</li>";
  return html;
}

function normalize(str) {
  return str.replace(/[^a-zA-Z0-9]/g, "").toLowerCase();
}

function cleanAndSlice(text) {
  if (!text) return [];
  var lines = text.split('\n');
  var startIndex = -1;
  for (var i = 0; i < lines.length; i++) {
    if (lines[i].toUpperCase().includes(ANCHOR_POINT)) {
      startIndex = i;
      break;
    }
  }
  var processedLines = (startIndex !== -1) ? lines.slice(startIndex + 1) : lines;
  return processedLines.map(function(l) { return l.trim(); }).filter(function(l) { return l !== ""; });
}

function escapeHtml(text) {
  if (!text) return "";
  return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
}
